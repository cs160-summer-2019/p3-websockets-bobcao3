{% load static %}

<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>On the Small Screen</title>

    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.1.6/css/uikit.min.css" />

    <!-- UIkit JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.1.6/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.1.6/js/uikit-icons.min.js"></script>
  
    <script type="text/javascript" src="{% static 'draw/vendor/jquery/jquery-3.3.1.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'draw/vendor/paper/paper-full.min.js' %}"></script>
  
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

    <style type="text/css">
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
        min-height: 100vh;
      }
    </style>

</head>
  {% verbatim %}
  
<body class="uk-dark uk-background-muted">
    <div class="uk-padding uk-flex uk-flex-wrap uk-flex-wrap-around uk-flex-center" id="app">
        <div class="uk-card uk-card-default uk-margin-left uk-margin-right uk-margin-top uk-margin-bottom uk-width-1-3" v-for="e in sortedEntries">
            <div class="uk-card-header" v-bind:class="{ 'uk-card-primary': e.vote >= 100 || useVotes }">
                <h4>{{ e.title }}</h4>
                <small>{{ e.name }}</small>
            </div>
            <div class="uk-card-body">
                <p>
                    Question: {{ e.text }}
                </p>
                <p>
                    Answer: {{ e.ans }}          
                </p>              
            </div>
            <div class="uk-card-footer">
                <a v-bind:uid="e.senderUid" v-on:click="notifyStu">Notify</a>
                <a v-bind:uid="e.senderUid" v-on:click="vote" v-if="useVotes">Vote: {{ e.vote }}</a>
                <a v-bind:uid="e.senderUid" v-on:click="pin" v-if="!useVotes && e.vote < 100">Pin</a>
                <a v-bind:uid="e.senderUid" v-on:click="unpin" v-if="!useVotes && e.vote >= 100">Pinned</a> 
            </div>
        </div>
    </div>
</body>
  
  {% endverbatim %}
<script>
    var urlParams = new URLSearchParams(window.location.search);
  

    var app = new Vue({
        el: '#app',
        data: {
          entries: [],
          useVotes: urlParams.get("useVotes")
        },
        methods: {
            notifyStu: function(event) {
                e = {
                    "type": "notify",
                    "msg":  "A TA / AI is comming to you",
                    "uid":  event.target.getAttribute("uid")
                }
                socket.send(JSON.stringify(e));
            },
            vote: function(event) {
                for (const [i, e] of this.entries.entries()) {
                    if (e.senderUid == event.target.getAttribute("uid")) {
                        e.vote += 1
                        break
                    }
                }
            },
            pin: function(event) {
                for (const [i, e] of this.entries.entries()) {
                    if (e.senderUid == event.target.getAttribute("uid")) {
                        e.vote = 200
                        break
                    }
                }
            },
            unpin: function(event) {
                for (const [i, e] of this.entries.entries()) {
                    if (e.senderUid == event.target.getAttribute("uid")) {
                        e.vote = 1
                        break
                    }
                }
            }
        },
        computed: {
            sortedEntries: function () {
                var sorted = this.entries.sort((a,b)=>{return b.vote - a.vote})
                return sorted
            }
        }
    })
    
    var url = window.location.href;

    var socket = new WebSocket(
        'wss://p3-websockets-bobcao3-bobcaocheng619338.codeanyapp.com/ws/draw');
  
    function uuidv4() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      )
    }
  
    function getRandomColor() {
      var letters = '0123456789ABCDEF';
      var color = '#';
      for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }
  
    var uuid = uuidv4();
  
    // triggered when receiving a message from the server
    socket.onmessage = function(receivedMessage) {
      // do something when you receive a message
      var event = JSON.parse(receivedMessage.data)
      
      if (event.type != "newQuestion") return;
      
      for (const [i, e] of app.entries.entries()) {
          if (e.senderUid == event.senderUid) {
              event.vote = e.vote
              Object.assign(e, event)
              return;
          }
      }
      
      event.vote = 1;
      app.entries.push(event)
      
    };

    // use when sending a message to the server
    // to be broadcasted to all clients, please add a delay
    //socket.send(message);

    // notify console if socket closes unexpectedly
    socket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

</script>
</html>
